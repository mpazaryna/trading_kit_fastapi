# test_main.py
import pytest
from httpx import AsyncClient

from trading_kit_fastapi.main import app


@pytest.mark.asyncio
async def test_analyze_stock_trends():
    async with AsyncClient(app=app, base_url="http://test") as ac:
        response = await ac.post(
            "/analyze_stock_trends",
            json={
                "company_name": "Test Corp",
                "dates": [
                    "2023-01-01",
                    "2023-01-02",
                    "2023-01-03",
                    "2023-01-04",
                    "2023-01-05",
                    "2023-01-06",
                    "2023-01-07",
                    "2023-01-08",
                    "2023-01-09",
                    "2023-01-10",
                    "2023-01-11",
                    "2023-01-12",
                    "2023-01-13",
                    "2023-01-14",
                    "2023-01-15",
                    "2023-01-16",
                    "2023-01-17",
                    "2023-01-18",
                    "2023-01-19",
                    "2023-01-20",
                    "2023-01-21",
                    "2023-01-22",
                    "2023-01-23",
                    "2023-01-24",
                    "2023-01-25",
                    "2023-01-26",
                    "2023-01-27",
                    "2023-01-28",
                    "2023-01-29",
                    "2023-01-30",
                    "2023-01-31",
                    "2023-02-01",
                    "2023-02-02",
                    "2023-02-03",
                    "2023-02-04",
                    "2023-02-05",
                    "2023-02-06",
                    "2023-02-07",
                    "2023-02-08",
                    "2023-02-09",
                    "2023-02-10",
                    "2023-02-11",
                    "2023-02-12",
                    "2023-02-13",
                    "2023-02-14",
                    "2023-02-15",
                    "2023-02-16",
                    "2023-02-17",
                    "2023-02-18",
                    "2023-02-19",
                    "2023-02-20",
                    "2023-02-21",
                    "2023-02-22",
                    "2023-02-23",
                    "2023-02-24",
                    "2023-02-25",
                    "2023-02-26",
                    "2023-02-27",
                    "2023-02-28",
                    "2023-03-01",
                    "2023-03-02",
                    "2023-03-03",
                    "2023-03-04",
                    "2023-03-05",
                    "2023-03-06",
                    "2023-03-07",
                    "2023-03-08",
                    "2023-03-09",
                    "2023-03-10",
                    "2023-03-11",
                    "2023-03-12",
                    "2023-03-13",
                    "2023-03-14",
                    "2023-03-15",
                    "2023-03-16",
                    "2023-03-17",
                    "2023-03-18",
                    "2023-03-19",
                    "2023-03-20",
                    "2023-03-21",
                    "2023-03-22",
                    "2023-03-23",
                    "2023-03-24",
                    "2023-03-25",
                    "2023-03-26",
                    "2023-03-27",
                    "2023-03-28",
                    "2023-03-29",
                    "2023-03-30",
                    "2023-03-31",
                    "2023-04-01",
                    "2023-04-02",
                    "2023-04-03",
                    "2023-04-04",
                    "2023-04-05",
                    "2023-04-06",
                    "2023-04-07",
                    "2023-04-08",
                    "2023-04-09",
                    "2023-04-10",
                ],
                "prices": [
                    100.00,
                    100.50,
                    100.91,
                    100.24,
                    100.76,
                    101.08,
                    101.83,
                    101.75,
                    101.42,
                    102.73,
                    102.76,
                    103.71,
                    103.73,
                    103.11,
                    103.42,
                    103.35,
                    103.09,
                    104.38,
                    105.25,
                    105.35,
                    105.53,
                    105.17,
                    105.41,
                    104.52,
                    104.11,
                    103.41,
                    103.46,
                    103.58,
                    103.46,
                    102.65,
                    102.20,
                    102.25,
                    101.94,
                    102.32,
                    102.04,
                    101.89,
                    102.39,
                    102.95,
                    103.04,
                    102.51,
                    103.81,
                    104.38,
                    104.49,
                    104.10,
                    104.38,
                    104.96,
                    106.16,
                    106.27,
                    106.50,
                    106.54,
                    106.98,
                    107.67,
                    107.01,
                    106.88,
                    107.14,
                    107.19,
                    107.20,
                    108.16,
                    108.76,
                    109.61,
                    110.37,
                    111.00,
                    111.62,
                    111.10,
                    110.93,
                    110.94,
                    110.98,
                    111.88,
                    112.24,
                    113.39,
                    113.60,
                    113.75,
                    114.17,
                    114.25,
                    114.36,
                    114.62,
                    114.90,
                    115.26,
                    115.42,
                    115.18,
                    115.14,
                    115.53,
                    115.49,
                    115.98,
                    116.46,
                    116.48,
                    116.99,
                    116.93,
                    116.95,
                    117.43,
                    117.48,
                    117.51,
                    117.84,
                    117.82,
                    117.66,
                    117.33,
                    117.92,
                    118.13,
                    118.25,
                    118.42,
                ],
                "short_window": 10,
                "long_window": 30,
                "precision": 2,
            },
        )
        assert response.status_code == 200
        result = response.json()
        assert result["company_name"] == "Test Corp"
        assert "short_wma" in result
        assert "long_wma" in result
        assert "signals" in result
        assert "summary" in result
